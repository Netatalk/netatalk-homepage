<div id="content">
<h1>Netatalk Security Advisory</h1>

<dl>
<dt><strong>Subject</strong></dt>
<dd>afpd daemon vulnerable to symlink redirection</dd>
<dt><strong>CVE ID</strong></dt>
<dd><a href="https://www.cve.org/CVERecord?id=CVE-2022-22995">CVE-2022-22995</a></dd>
<dt><strong>Date of Publishing</strong></dt>
<dd>2023/10/05</dd>
<dt><strong>Affected Netatalk Versions</strong></dt>
<dd>3.1.0 - 3.1.17</dd>
<dt><strong>Summary</strong></dt>
<dd>When configured with AppleDouble v2, afpd can be tricked to move files to an arbitrary location</dd>
</dl>
<h2>Description</h2>
<p>The create_appledesktop_folder function of netatalk can be used to unsafely move files outside
the shared volume using the "mv" system utility. The create_appledesktop_folder function is called
when netatalk is configured to use the legacy AppleDouble v2 format of file system meta data.</p>

<p>By using the features of another file sharing protocol, like SMB, an attacker could abuse
this primitive to create an arbitrary symbolic link and move it outside the share.
The attacker could then reuse the created symlink to write arbitrary files on the targeted system.
On the targeted device where it was demonstrated,
writing arbitrary files on the system resulted in a remote code execution.</p>

<p>The vulnerable code was introduced with <a href="https://netatalk.io/3.1/ReleaseNotes3.1.0">Netatalk 3.0alpha3<a>.
As part of the upgrade path from Netatalk 3.0 (and earlier) to Netatalk 3.1, it attempts to automatically move
any existing .AppleDesktop directory from the root of the shared volume to the shared CNID database directory.</p>

<h2>Patch Availability</h2>
<p>Apply the patch with git hash
<a href="https://github.com/Netatalk/netatalk/commit/9eb6d9d0ac17dca210ccbf05476a925a6b379dfb.diff">
9eb6d9d</a> to hotfix your local Netatalk deployment.</p>

<p>Additionally, Netatalk 3.1.18 has been released which contains the security patch.
Netatalk administrators are advised to upgrade to this version or apply the patch as soon as possible.</p>

<h2>CVSSv3 Calculation</h2>
<p>CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H (7.2)</p>

<h2>Workaround</h2>
<p>Either one of the following measures will prevent the exploit. Both can be used in tandem for an extra layer of protection.</p>
<p>Configure Netatalk to use the Extended Attributes AppleDouble format: add "appledouble = ea" to the appropriate section in afp.conf</p>
<p>When a shared volume is accessed by another file sharing service such as Samba, make sure that ".AppleDesktop" is on the veto file list for said file sharing service.</p>

<h2>Credits</h2>
<dl>
<dt>Vulnerability found and reported by:</dt>
<dd>Corentin BAYET (@OnlyTheDuck), Etienne HELLUY-LAFONT and Luca MORO (@johncool__) from Synacktiv</dd>
<dt>Patch developed by:</dt>
<dd>Daniel Markstedt of the Netatalk team</dd>
</dl>

</div>
