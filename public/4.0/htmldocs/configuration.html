<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Chapter 3. Setting up Netatalk</title>
    <link rel="stylesheet" type="text/css" href="netatalk.css" />
    <meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" />
    <link rel="home" href="index.html" title="Netatalk Manual" />
    <link rel="up" href="index.html" title="Netatalk Manual" />
    <link rel="prev" href="installation.html" title="Chapter 2. Installation" />
    <link rel="next" href="appletalk.html" title="Chapter 4. AppleTalk" />
  </head>
  <body>
    <div class="navheader">
      <table width="100%" summary="Navigation header">
        <tr>
          <th colspan="3" align="center">Chapter 3. Setting up Netatalk</th>
        </tr>
        <tr>
          <td width="20%" align="left"><a accesskey="p" href="installation.html">Prev</a> </td>
          <th width="60%" align="center"> </th>
          <td width="20%" align="right"> <a accesskey="n" href="appletalk.html">Next</a></td>
        </tr>
      </table>
      <hr />
    </div>
    <div class="chapter">
      <div class="titlepage">
        <div>
          <div>
            <h1 class="title"><a id="configuration"></a>Chapter 3. Setting up Netatalk</h1>
          </div>
        </div>
      </div>
      <div class="toc">
        <p>
          <strong>Table of Contents</strong>
        </p>
        <dl class="toc">
          <dt>
            <span class="sect1">
              <a href="configuration.html#id-1.6.2">Setting up the AFP file server</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="sect2">
                  <a href="configuration.html#id-1.6.2.7">afp.conf</a>
                </span>
              </dt>
            </dl>
          </dd>
          <dt>
            <span class="sect1">
              <a href="configuration.html#CNID-backends">CNID backends</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="sect2">
                  <a href="configuration.html#id-1.6.3.8">dbd</a>
                </span>
              </dt>
              <dt>
                <span class="sect2">
                  <a href="configuration.html#id-1.6.3.9">last</a>
                </span>
              </dt>
              <dt>
                <span class="sect2">
                  <a href="configuration.html#id-1.6.3.10">mysql</a>
                </span>
              </dt>
            </dl>
          </dd>
          <dt>
            <span class="sect1">
              <a href="configuration.html#charsets">Charsets/Unicode</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="sect2">
                  <a href="configuration.html#id-1.6.4.2">Why Unicode?</a>
                </span>
              </dt>
              <dt>
                <span class="sect2">
                  <a href="configuration.html#id-1.6.4.3">Character sets used by Apple</a>
                </span>
              </dt>
              <dt>
                <span class="sect2">
                  <a href="configuration.html#id-1.6.4.4">afpd and character sets</a>
                </span>
              </dt>
            </dl>
          </dd>
          <dt>
            <span class="sect1">
              <a href="configuration.html#authentication">Authentication</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="sect2">
                  <a href="configuration.html#id-1.6.5.2">AFP authentication basics</a>
                </span>
              </dt>
              <dt>
                <span class="sect2">
                  <a href="configuration.html#id-1.6.5.3">UAMs supported by Netatalk</a>
                </span>
              </dt>
              <dt>
                <span class="sect2">
                  <a href="configuration.html#id-1.6.5.4">Which UAMs to activate?</a>
                </span>
              </dt>
              <dt>
                <span class="sect2">
                  <a href="configuration.html#id-1.6.5.5">Using different authentication sources with specific UAMs</a>
                </span>
              </dt>
              <dt>
                <span class="sect2">
                  <a href="configuration.html#id-1.6.5.6">Netatalk UAM overview table</a>
                </span>
              </dt>
              <dt>
                <span class="sect2">
                  <a href="configuration.html#sshtunnel">SSH tunneling</a>
                </span>
              </dt>
            </dl>
          </dd>
          <dt>
            <span class="sect1">
              <a href="configuration.html#acls">ACL Support</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="sect2">
                  <a href="configuration.html#id-1.6.6.3">Configuration</a>
                </span>
              </dt>
              <dt>
                <span class="sect2">
                  <a href="configuration.html#id-1.6.6.4">macOS ACLs</a>
                </span>
              </dt>
              <dt>
                <span class="sect2">
                  <a href="configuration.html#id-1.6.6.5">ZFS ACLs</a>
                </span>
              </dt>
              <dt>
                <span class="sect2">
                  <a href="configuration.html#id-1.6.6.6">POSIX ACLs</a>
                </span>
              </dt>
            </dl>
          </dd>
          <dt>
            <span class="sect1">
              <a href="configuration.html#fce">Filesystem Change Events</a>
            </span>
          </dt>
          <dt>
            <span class="sect1">
              <a href="configuration.html#id-1.6.8">Spotlight</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="sect2">
                  <a href="configuration.html#id-1.6.8.3">Configuration</a>
                </span>
              </dt>
              <dt>
                <span class="sect2">
                  <a href="configuration.html#id-1.6.8.4">Using Tracker commandline tools on the server</a>
                </span>
              </dt>
              <dt>
                <span class="sect2">
                  <a href="configuration.html#id-1.6.8.5">Supported metadata attributes</a>
                </span>
              </dt>
            </dl>
          </dd>
        </dl>
      </div>
      <div class="sect1">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title" style="clear: both"><a id="id-1.6.2"></a>Setting up the AFP file server</h2>
            </div>
          </div>
        </div>
        <p>AFP<a id="id-1.6.2.2.1" class="indexterm"></a> (the Apple Filing Protocol) is a protocol used on the Apple
    Macintosh for file services<a id="id-1.6.2.2.2" class="indexterm"></a>. The protocol has evolved over the years. The final
    revision of the protocol, AFP 3.4, was introduced with OS X Lion<a id="id-1.6.2.2.3" class="indexterm"></a> (10.7).</p>
        <p>Netatalk's <span class="command"><strong>afpd</strong></span> daemon offers AFP fileservices to
    Apple clients. The configuration is managed through the
    <code class="filename">afp.conf</code> file which uses an ini style configuration
    syntax.</p>
        <p>Support for <a class="link" href="configuration.html#spotlight">Spotlight</a><a id="id-1.6.2.4.2" class="indexterm"></a> was added in Netatalk 3.1.</p>
        <p>Mac OS X 10.5 (Leopard) introduced support for Time Machine backups
    over AFP. Two new functions ensure that backups are written to disk, not
    just in the server's cache. Different host operating systems honor this
    cache flushing differently. To make a volume a Time Machine target, use
    the volume option "<code class="option">time machine = yes</code>".</p>
        <p>Starting with Netatalk 2.1 UNIX symlinks<a id="id-1.6.2.6.1" class="indexterm"></a> can be used on the server. Semantics are the same as for
    e.g. NFS, i.e. they are not resolved on the server side but instead it's
    completely up to the client to resolve them, resulting in links that point
    somewhere inside the clients filesystem view.</p>
        <div class="sect2">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="id-1.6.2.7"></a>afp.conf</h3>
              </div>
            </div>
          </div>
          <p><code class="filename">afp.conf</code> is the configuration file used by
      afpd to determine the behaviour and configuration of the AFP file server
      and the AFP volume that it provides.</p>
          <p>The <code class="filename">afp.conf</code> is divided into several
      sections:</p>
          <div class="variablelist">
            <dl class="variablelist">
              <dt>
                <span class="term">[Global]</span>
              </dt>
              <dd>
                <p>The global section defines general server options</p>
              </dd>
              <dt>
                <span class="term">[Homes]</span>
              </dt>
              <dd>
                <p>The homes section defines user home volumes</p>
              </dd>
            </dl>
          </div>
          <p>Any section not called <code class="option">Global</code> or
      <code class="option">Homes</code> is interpreted as an AFP volume.</p>
          <p>For sharing user homes by defining a <code class="option">Homes</code>
      section you must specify the option <code class="option">basedir regex</code> which
      can be a simple string with the path to the parent directory of all user
      homes or a regular expression.</p>
          <p>Example:</p>
          <pre class="programlisting">[Homes]
basedir regex = /home
</pre>
          <p>Now any user logging into the AFP server will have a user volume
      available whose path is <code class="filename">/home/NAME</code>.</p>
          <p>A more complex setup would be a server with a large amount of user
      homes which are split across e.g. two different
      filesystems:</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
                <p>/RAID1/homes</p>
              </li>
              <li class="listitem">
                <p>/RAID2/morehomes</p>
              </li>
            </ul>
          </div>
          <p>The following configuration is
      required:</p>
          <pre class="programlisting">[Homes]
basedir regex = /RAID./.*homes
</pre>
          <p>If <code class="option">basedir regex</code> contains a symlink, set the
      canonicalized absolute path. When <code class="filename">/home</code> links to
      <code class="filename">/usr/home</code>: </p>
          <pre class="programlisting">[Homes]
basedir regex = /usr/home</pre>
          <p>For a more detailed explanation of the available options, please
      refer to the <span class="citerefentry"><span class="refentrytitle">afp.conf</span>(5)</span> man page.</p>
        </div>
      </div>
      <div class="sect1">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title" style="clear: both"><a id="CNID-backends"></a>CNID<a id="id-1.6.3.1.1" class="indexterm"></a> backends<a id="id-1.6.3.1.2" class="indexterm"></a></h2>
            </div>
          </div>
        </div>
        <p>Unlike other protocols like SMB or NFS, the AFP protocol mostly
    refers to files and directories by ID and not by a path (the IDs are also
    called CNID, which stand for Catalog Node ID). A typical AFP request uses
    a directory ID<a id="id-1.6.3.2.1" class="indexterm"></a> and a filename, something like <span class="phrase">"server, please open
    the file named 'Test' in the directory with id 167"</span>. For example
    "Aliases" on the Mac basically work by ID (with a fallback to the absolute
    path in more recent AFP clients. But this applies only to Finder, not to
    applications).</p>
        <p>Every file in an AFP volume has to have a unique file ID<a id="id-1.6.3.3.1" class="indexterm"></a>, IDs must, according to the specs, never be reused, and IDs
    are 32 bit numbers (Directory IDs use the same ID pool). So, after ~4
    billion files/folders have been written to an AFP volume, the ID pool is
    depleted and no new file can be written to the volume. No whining please
    :-)</p>
        <p>Netatalk needs to map IDs to files and folders in the host
    filesystem. To achieve this, several different CNID backends<a id="id-1.6.3.4.1" class="indexterm"></a> are available and can be selected with the <code class="option">cnid
    scheme</code><a id="id-1.6.3.4.3" class="indexterm"></a> option in the <span class="citerefentry"><span class="refentrytitle">afp.conf</span>(5)</span> configuration file. A CNID backend is basically a
    database storing ID &lt;-&gt; name mappings.</p>
        <p>The CNID databases are by default located in
    <code class="filename">/var/netatalk/CNID</code>. You can change the location by
    configuring <span class="command"><strong>localstatedir</strong></span> at compile time.</p>
        <p>There is a command line utility called <span class="command"><strong>dbd</strong></span>
    available which can be used to verify, repair and rebuild the CNID
    database.</p>
        <div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">
          <h3 class="title">Note</h3>
          <p>There are some CNID related things you should keep in mind when
      working with netatalk:</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
                <p>Don't nest volumes<a id="id-1.6.3.7.2.1.1.1" class="indexterm"></a> unless "<code class="option">vol dbnest = yes</code>" is
          set.</p>
              </li>
              <li class="listitem">
                <p>CNID backends are databases, so they turn afpd into a file
          server/database mix.</p>
              </li>
              <li class="listitem">
                <p>If there's no more space on the filesystem left, the database
          will get corrupted. You can work around this by using the
          <code class="option">vol dbpath</code> option and put the database files into
          another location.</p>
              </li>
              <li class="listitem">
                <p>Be careful with CNID databases for volumes that are mounted
          via NFS. That is a pretty audacious decision to make anyway, but
          putting a database there as well is really asking for trouble, i.e.
          database corruption. Use the <code class="option">vol dbpath</code> directive
          to put the databases onto a local disk if you must use NFS<a id="id-1.6.3.7.2.4.1.2" class="indexterm"></a> mounted volumes.</p>
              </li>
            </ul>
          </div>
        </div>
        <div class="sect2">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="id-1.6.3.8"></a>dbd<a id="id-1.6.3.8.1.1" class="indexterm"></a></h3>
              </div>
            </div>
          </div>
          <p>The "Database Daemon" backend is built on Berkeley DB. Access to
      the CNID database is restricted to the cnid_dbd daemon process. afpd
      processes communicate with the daemon for database reads and updates.
      The probability for database corruption is practically zero.</p>
          <p>This is the default backend since Netatalk 2.1.</p>
        </div>
        <div class="sect2">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="id-1.6.3.9"></a>last<a id="id-1.6.3.9.1.1" class="indexterm"></a></h3>
              </div>
            </div>
          </div>
          <p>The last backend is an in-memory tdb database. It is not
      persistent. Starting with netatalk 3.0, it operates in <span class="emphasis"><em>read
      only mode</em></span> automatically. This is useful e.g. for mounting
      CD-ROMs.</p>
        </div>
        <div class="sect2">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="id-1.6.3.10"></a>mysql<a id="id-1.6.3.10.1.1" class="indexterm"></a></h3>
              </div>
            </div>
          </div>
          <p>CNID backend using a MySQL server. The MySQL server has to be
      provisioned by the system administrator.</p>
        </div>
      </div>
      <div class="sect1">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title" style="clear: both"><a id="charsets"></a>Charsets<a id="id-1.6.4.1.1" class="indexterm"></a>/Unicode<a id="id-1.6.4.1.2" class="indexterm"></a></h2>
            </div>
          </div>
        </div>
        <div class="sect2">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="id-1.6.4.2"></a>Why Unicode?</h3>
              </div>
            </div>
          </div>
          <p>Internally, computers don't know anything about characters and
      texts, they only know numbers. Therefore, each letter is assigned a
      number. A character set, often referred to as
      <span class="emphasis"><em>charset</em></span> or <span class="emphasis"><em>codepage</em></span><a id="id-1.6.4.2.2.3" class="indexterm"></a>, defines the mappings between numbers and letters.</p>
          <p>If two or more computer systems need to communicate with each
      other, the have to use the same character set. In the 1960s the
      ASCII<a id="id-1.6.4.2.3.1" class="indexterm"></a> (American Standard Code for Information Interchange)
      character set was defined by the American Standards Association. The
      original form of ASCII represented 128 characters, more than enough to
      cover the English alphabet and numerals. Up to date, ASCII has been the
      normative character scheme used by computers.</p>
          <p>Later versions defined 256 characters to produce a more
      international fluency and to include some slightly esoteric graphical
      characters. Using this mode of encoding each character takes exactly one
      byte. Obviously, 256 characters still wasn't enough to map all the
      characters used in the various languages into one character set.</p>
          <p>As a result localized character sets were defined later, e.g the
      ISO-8859 character sets. Most operating system vendors introduced their
      own characters sets to satisfy their needs, e.g. IBM defined the
      <span class="emphasis"><em>codepage 437 (DOSLatinUS)</em></span>, Apple introduced the
      <span class="emphasis"><em>MacRoman</em></span><a id="id-1.6.4.2.5.3" class="indexterm"></a> codepage and so on. The characters that were assigned
      number larger than 127 were referred to as <span class="emphasis"><em>extended</em></span>
      characters. These character sets conflict with another, as they use the
      same number for different characters, or vice versa.</p>
          <p>Almost all of those characters sets defined 256 characters, where
      the first 128 (0-127) character mappings are identical to ASCII. As a
      result, communication between systems using different codepages was
      effectively limited to the ASCII charset.</p>
          <p>To solve this problem new, larger character sets were defined. To
      make room for more character mappings, these character sets use at least
      2 bytes to store a character. They are therefore referred to as
      <span class="emphasis"><em>multibyte</em></span> character sets.</p>
          <p>One standardized multibyte charset encoding scheme is known as
      <a class="ulink" href="http://www.unicode.org/" target="_top">unicode</a>. A big advantage of
      using a multibyte charset is that you only need one. There is no need to
      make sure two computers use the same charset when they are
      communicating.</p>
        </div>
        <div class="sect2">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="id-1.6.4.3"></a>Character sets used by Apple</h3>
              </div>
            </div>
          </div>
          <p>In the past, Apple clients used single-byte charsets to
      communicate over the network. Over the years Apple defined a number of
      codepages, western users will most likely be using the
      <span class="emphasis"><em>MacRoman</em></span> codepage.</p>
          <p>Codepages defined by Apple include:</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
                <p>MacArabic, MacFarsi</p>
              </li>
              <li class="listitem">
                <p>MacCentralEurope</p>
              </li>
              <li class="listitem">
                <p>MacChineseSimple</p>
              </li>
              <li class="listitem">
                <p>MacChineseTraditional</p>
              </li>
              <li class="listitem">
                <p>MacCroatian</p>
              </li>
              <li class="listitem">
                <p>MacCyrillic</p>
              </li>
              <li class="listitem">
                <p>MacDevanagari</p>
              </li>
              <li class="listitem">
                <p>MacGreek</p>
              </li>
              <li class="listitem">
                <p>MacHebrew</p>
              </li>
              <li class="listitem">
                <p>MacIcelandic</p>
              </li>
              <li class="listitem">
                <p>MacJapanese</p>
              </li>
              <li class="listitem">
                <p>MacKorean</p>
              </li>
              <li class="listitem">
                <p>MacRoman</p>
              </li>
              <li class="listitem">
                <p>MacRomanian</p>
              </li>
              <li class="listitem">
                <p>MacThai</p>
              </li>
              <li class="listitem">
                <p>MacTurkish</p>
              </li>
            </ul>
          </div>
          <p>Starting with Mac OS X and AFP3, <a class="ulink" href="http://www.utf-8.com/" target="_top">UTF-8</a> is used. UTF-8 encodes Unicode
      characters in an ASCII compatible way, each Unicode character is encoded
      into 1-6 ASCII characters. UTF-8 is therefore not really a charset
      itself, it's an encoding of the Unicode charset.</p>
          <p>To complicate things, Unicode defines several <span class="emphasis"><em> <a class="ulink" href="http://www.unicode.org/reports/tr15/index.html" target="_top">normalization</a>
      </em></span> forms. While <a class="ulink" href="http://www.samba.org" target="_top">samba</a><a id="id-1.6.4.3.6.3" class="indexterm"></a> uses <span class="emphasis"><em>precomposed</em></span><a id="id-1.6.4.3.6.5" class="indexterm"></a> Unicode, which most UNIX tools prefer as well, Apple
      decided to use the <span class="emphasis"><em>decomposed</em></span><a id="id-1.6.4.3.6.7" class="indexterm"></a> normalization.</p>
          <p>For example lets take the German character '<span class="keycode">ä</span>'.
      Using the precomposed normalization, Unicode maps this character to
      0xE4. In decomposed normalization, 'ä' is actually mapped to two
      characters, 0x61 and 0x308. 0x61 is the mapping for an 'a', 0x308 is the
      mapping for a <span class="emphasis"><em>COMBINING DIAERESIS</em></span>.</p>
          <p>Netatalk refers to precomposed UTF-8 as
      <span class="emphasis"><em>UTF8</em></span><a id="id-1.6.4.3.8.2" class="indexterm"></a> and to decomposed UTF-8 as
      <span class="emphasis"><em>UTF8-MAC</em></span><a id="id-1.6.4.3.8.4" class="indexterm"></a>.</p>
        </div>
        <div class="sect2">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="id-1.6.4.4"></a>afpd and character sets</h3>
              </div>
            </div>
          </div>
          <p>To support new AFP 3.x and older AFP 2.x clients at the same time,
      afpd needs to be able to convert between the various charsets used. AFP
      3.x clients always use UTF8-MAC, while AFP 2.x clients use one of the
      Apple codepages.</p>
          <p>At the time of writing, netatalk supports the following Apple
      codepages:</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
                <p>MAC_CENTRALEUROPE</p>
              </li>
              <li class="listitem">
                <p>MAC_CHINESE_SIMP</p>
              </li>
              <li class="listitem">
                <p>MAC_CHINESE_TRAD</p>
              </li>
              <li class="listitem">
                <p>MAC_CYRILLIC</p>
              </li>
              <li class="listitem">
                <p>MAC_GREEK</p>
              </li>
              <li class="listitem">
                <p>MAC_HEBREW</p>
              </li>
              <li class="listitem">
                <p>MAC_JAPANESE</p>
              </li>
              <li class="listitem">
                <p>MAC_KOREAN</p>
              </li>
              <li class="listitem">
                <p>MAC_ROMAN</p>
              </li>
              <li class="listitem">
                <p>MAC_TURKISH</p>
              </li>
            </ul>
          </div>
          <p>afpd handles three different character set options:</p>
          <div class="variablelist">
            <dl class="variablelist">
              <dt>
                <span class="term">unix charset<a id="id-1.6.4.4.6.1.1.1" class="indexterm"></a></span>
              </dt>
              <dd>
                <p>This is the codepage used internally by your operating
            system. If not specified, it defaults to <code class="option">UTF8</code>. If
            <code class="option">LOCALE</code> is specified and your system support UNIX
            locales, afpd tries to detect the codepage. afpd uses this
            codepage to read its configuration files, so you can use extended
            characters for volume names, login messages, etc. See
            <span class="citerefentry"><span class="refentrytitle">afp.conf</span>(5)</span>.</p>
              </dd>
              <dt>
                <span class="term">mac charset<a id="id-1.6.4.4.6.2.1.1" class="indexterm"></a></span>
              </dt>
              <dd>
                <p>As already mentioned, older Mac OS clients (up to AFP 2.2)
            use codepages to communicate with afpd. However, there is no
            support for negotiating the codepage used by the client in the AFP
            protocol. If not specified otherwise, afpd assumes the
            <span class="emphasis"><em>MacRoman</em></span> codepage is used. In case you're
            clients use another codepage, e.g.
            <span class="emphasis"><em>MacCyrillic</em></span>, you'll <span class="bold"><strong>have</strong></span> to explicitly configure this. see
            <span class="citerefentry"><span class="refentrytitle">afp.conf</span>(5)</span>.</p>
              </dd>
              <dt>
                <span class="term">vol charset<a id="id-1.6.4.4.6.3.1.1" class="indexterm"></a></span>
              </dt>
              <dd>
                <p>This defines the charset afpd should use for filenames on
            disk. By default, it is the same as <code class="option">unix charset</code>.
            If you have <a class="ulink" href="http://www.gnu.org/software/libiconv/" target="_top">iconv</a><a id="id-1.6.4.4.6.3.2.1.3" class="indexterm"></a> installed, you can use any iconv provided charset
            as well.</p>
                <p>afpd needs a way to preserve extended Macintosh characters,
            or characters illegal in UNIX filenames, when saving files on a
            UNIX filesystem. Earlier versions used the the so called CAP
            encoding<a id="id-1.6.4.4.6.3.2.2.1" class="indexterm"></a>. An extended character (&gt;0x7F) would be
            converted to a :xx hex sequence, e.g. the Apple Logo (MacRoman:
            0xF0) was saved as :f0. Some special characters will be converted
            as to :xx notation as well. '/' will be encoded to :2f, if
            <code class="option">usedots</code> was not specified, a leading dot '.' will
            be encoded as :2e.</p>
                <p>Even though this version now uses <code class="option">UTF8</code> as
            the default encoding for filenames, '/' will be converted to ':'.
            For western users another useful setting could be <code class="option">vol
            charset = ISO-8859-15</code>.</p>
                <p>If a character cannot be converted from the <code class="option">mac
            charset</code> to the selected <code class="option">vol charset</code>,
            you'll receive a -50 error on the mac. <span class="emphasis"><em>Note</em></span>:
            Whenever you can, please stick with the default UTF8 volume
            format. See <span class="citerefentry"><span class="refentrytitle">afp.conf</span>(5)</span>.</p>
              </dd>
            </dl>
          </div>
        </div>
      </div>
      <div class="sect1">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title" style="clear: both"><a id="authentication"></a>Authentication<a id="id-1.6.5.1.1" class="indexterm"></a></h2>
            </div>
          </div>
        </div>
        <div class="sect2">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="id-1.6.5.2"></a>AFP authentication basics</h3>
              </div>
            </div>
          </div>
          <p>Apple chose a flexible model called "User Authentication
      Modules"<a id="id-1.6.5.2.2.1" class="indexterm"></a> (UAMs) for authentication purposes between AFP client and
      server. An AFP client initially connecting to an AFP server will ask for
      the list of UAMs which the server provides, and will choose the one with
      strongest encryption that the client supports.</p>
          <p>Several UAMs have been developed by Apple over the time, some by
      3rd-party developers.</p>
        </div>
        <div class="sect2">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="id-1.6.5.3"></a>UAMs supported by Netatalk</h3>
              </div>
            </div>
          </div>
          <p>Netatalk supports the following ones by default:</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
                <p>"No User Authent"<a id="id-1.6.5.3.3.1.1.1" class="indexterm"></a> UAM (guest access without authentication)</p>
              </li>
              <li class="listitem">
                <p>"Cleartxt Passwrd"<a id="id-1.6.5.3.3.2.1.1" class="indexterm"></a> UAM (no password encryption)</p>
              </li>
              <li class="listitem">
                <p>"Randnum exchange"<a id="id-1.6.5.3.3.3.1.1" class="indexterm"></a>/"2-Way Randnum exchange"<a id="id-1.6.5.3.3.3.1.2" class="indexterm"></a> UAMs (weak password encryption, separate password
          storage)</p>
              </li>
              <li class="listitem">
                <p>"DHCAST128"<a id="id-1.6.5.3.3.4.1.1" class="indexterm"></a> UAM (a.k.a. DHX; stronger password encryption)</p>
              </li>
              <li class="listitem">
                <p>"DHX2"<a id="id-1.6.5.3.3.5.1.1" class="indexterm"></a> UAM (successor of DHCAST128)</p>
              </li>
            </ul>
          </div>
          <p>There exist other optional UAMs as well:</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
                <p>"PGPuam 1.0"<a id="id-1.6.5.3.5.1.1.1" class="indexterm"></a><a id="id-1.6.5.3.5.1.1.2" class="indexterm"></a> UAM (PGP-based authentication for pre-Mac OS X
          clients. You'll also need the <a class="ulink" href="https://web.archive.org/web/20190121142716/http://www.vmeng.com/vinnie/papers/pgpuam.html" target="_top">PGPuam
          client</a> to let this work)</p>
              </li>
              <li class="listitem">
                <p>"Client Krb v2"<a id="id-1.6.5.3.5.2.1.1" class="indexterm"></a> UAM (Kerberos V, suitable for "Single Sign On"
          Scenarios with macOS clients – see below)</p>
              </li>
            </ul>
          </div>
          <p>You can configure which UAMs should be activated by defining
      "<code class="option">uam list</code>" in <code class="option">Global</code> section.
      <span class="command"><strong>afpd</strong></span> will log which UAMs it's using and if problems
      occur while activating them in either <code class="filename">netatalk.log</code>
      or syslog at startup time. <span class="citerefentry"><span class="refentrytitle">asip-status</span>(1)</span> can be used to query the available UAMs of AFP servers
      as well.</p>
          <p>Having a specific UAM available at the server does not
      automatically mean that a client can use it. Client-side support is also
      necessary. For older Macintoshes running Classic Mac OS, DHCAST128
      support exists since AppleShare client 3.8.x.</p>
          <p>On macOS, there exist some client-side techniques to make the
      AFP-client more verbose, so one can have a look what's happening while
      negotiating the UAMs to use. Compare with this <a class="ulink" href="https://web.archive.org/web/20080312054723/http://article.gmane.org/gmane.network.netatalk.devel/7383/" target="_top">hint</a>.</p>
        </div>
        <div class="sect2">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="id-1.6.5.4"></a>Which UAMs to activate?</h3>
              </div>
            </div>
          </div>
          <p>It depends primarily on your needs and on the kind of macOS
      clients you have to support. If your network consists of exclusively
      macOS (Mac OS X) clients, DHX2 is sufficient, and provides the strongest
      encryption.</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
                <p>Unless you really have to supply guest access to your server's
          volumes ensure that you disable "No User Authent" since it might
          lead accidentally to unauthorized access. In case you must enable
          guest access take care that you enforce this on a per volume base
          using the access controls.</p>
                <p>Note: "No User Authent" is required to use Apple II NetBoot
          services (<span class="citerefentry"><span class="refentrytitle">a2boot</span>(8)</span>) to boot an Apple //e over AFP.</p>
              </li>
              <li class="listitem">
                <p>The "ClearTxt Passwrd" UAM is as bad as it sounds since
          passwords go unencrypted over the wire. Try to avoid it at both the
          server's side as well as on the client's.</p>
                <p>Note: If you want to provide Mac OS 8/9 clients with
          NetBoot-services then you need uams_cleartext.so since the
          AFP-client integrated into the Mac's firmware can only deal with
          this basic form of authentication.</p>
              </li>
              <li class="listitem">
                <p>Since "Randnum exchange"/"2-Way Randnum exchange" uses only 56
          bit DES for encryption it should be avoided as well. Another
          disadvantage is the fact that the passwords have to be stored in
          cleartext on the server and that it doesn't integrate into both PAM
          scenarios or classic /etc/shadow (you have to administrate passwords
          separately by using the <span class="citerefentry"><span class="refentrytitle">afppasswd</span>(1)</span> utility, in order for clients to use these
          UAMs)</p>
                <p>However, this is the strongest form of authentication that can
          be used with Macintosh System Software 7.1 or earlier.</p>
              </li>
              <li class="listitem">
                <p>"DHCAST128" ("DHX") or "DHX2" should be the sweet spot for
          most people since it combines stronger encryption with PAM
          integration.</p>
              </li>
              <li class="listitem">
                <p>Using the Kerberos V<a id="id-1.6.5.4.3.5.1.1" class="indexterm"></a> ("Client Krb v2") UAM, it's possible to implement
          real single sign on scenarios using Kerberos tickets. The password
          is not sent over the network. Instead, the user password is used to
          decrypt a service ticket for the AppleShare server. The service
          ticket contains an encryption key for the client and some encrypted
          data (which only the AppleShare server can decrypt). The encrypted
          portion of the service ticket is sent to the server and used to
          authenticate the user. Because of the way that the afpd service
          principal detection is implemented, this authentication method is
          vulnerable to man-in-the-middle attacks.</p>
              </li>
            </ul>
          </div>
          <p>For a more detailed overview over the technical implications of
      the different UAMs, please have a look at Apple's <a class="ulink" href="http://developer.apple.com/library/mac/#documentation/Networking/Conceptual/AFP/AFPSecurity/AFPSecurity.html#//apple_ref/doc/uid/TP40000854-CH232-SW1" target="_top">File
      Server Security</a> pages.</p>
        </div>
        <div class="sect2">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="id-1.6.5.5"></a>Using different authentication sources with specific UAMs</h3>
              </div>
            </div>
          </div>
          <p>Some UAMs provide the ability to use different authentication
      "backends", namely <code class="filename">uams_cleartext.so</code>,
      <code class="filename">uams_dhx.so</code> and <code class="filename">uams_dhx2.so</code>.
      They can use either classic UNIX passwords from
      <code class="filename">/etc/passwd</code> (<code class="filename">/etc/shadow</code>) or
      PAM if the system supports that. <code class="filename">uams_cleartext.so</code>
      can be symlinked to either <code class="filename">uams_passwd.so</code> or
      <code class="filename">uams_pam.so</code>, <code class="filename">uams_dhx.so</code> to
      <code class="filename">uams_dhx_passwd.so</code> or
      <code class="filename">uams_dhx_pam.so</code> and
      <code class="filename">uams_dhx2.so</code> to
      <code class="filename">uams_dhx2_passwd.so</code> or
      <code class="filename">uams_dhx2_pam.so</code>.</p>
          <p>So, if it looks like this in Netatalk's UAMs folder (per default
      <code class="filename">/etc/netatalk/uams/</code>):</p>
          <pre class="programlisting">uams_clrtxt.so -&gt; uams_pam.so
uams_dhx.so -&gt; uams_dhx_pam.so
uams_dhx2.so -&gt; uams_dhx2_pam.so</pre>
          <p> then you're using PAM,
      otherwise classic UNIX passwords. The main advantage of using PAM is
      that one can integrate Netatalk in centralized authentication scenarios,
      e.g. via LDAP, NIS and the like. Please always keep in mind that the
      protection of your user's login credentials in such scenarios also
      depends on the strength of encryption that the UAM in question supplies.
      So think about eliminating weak UAMs like "ClearTxt Passwrd" and
      "Randnum exchange" completely from your network.</p>
        </div>
        <div class="sect2">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="id-1.6.5.6"></a>Netatalk UAM overview table</h3>
              </div>
            </div>
          </div>
          <p>A small overview of the most common used UAMs.</p>
          <div class="table">
            <a id="id-1.6.5.6.3"></a>
            <p class="title">
              <strong>Table 3.1. Netatalk UAM overview</strong>
            </p>
            <div class="table-contents">
              <table class="table" summary="Netatalk UAM overview" border="1">
                <colgroup>
                  <col align="center" class="col1" />
                  <col align="center" class="uam_guest" />
                  <col align="center" class="uam_clrtxt" />
                  <col align="center" class="uam_randnum" />
                  <col align="center" class="uam_dhx" />
                  <col align="center" class="uam_dhx2" />
                  <col align="center" class="uam_gss" />
                </colgroup>
                <tbody>
                  <tr>
                    <td align="center" valign="middle">UAM</td>
                    <td align="center">No User Authent<a id="id-1.6.5.6.3.2.8.1.2.1" class="indexterm"></a></td>
                    <td align="center">Cleartxt Passwrd<a id="id-1.6.5.6.3.2.8.1.3.1" class="indexterm"></a></td>
                    <td align="center">(2-Way) Randnum exchange<a id="id-1.6.5.6.3.2.8.1.4.1" class="indexterm"></a></td>
                    <td align="center">DHCAST128<a id="id-1.6.5.6.3.2.8.1.5.1" class="indexterm"></a></td>
                    <td align="center">DHX2<a id="id-1.6.5.6.3.2.8.1.6.1" class="indexterm"></a></td>
                    <td align="center">Client Krb v2<a id="id-1.6.5.6.3.2.8.1.7.1" class="indexterm"></a></td>
                  </tr>
                  <tr>
                    <td align="center" valign="middle">Password
              length</td>
                    <td align="center">guest access</td>
                    <td align="center">max. 8 characters</td>
                    <td align="center">max. 8 characters</td>
                    <td align="center">max. 64 characters</td>
                    <td align="center">max. 256 characters</td>
                    <td align="center">Kerberos tickets</td>
                  </tr>
                  <tr>
                    <td align="center" valign="middle">Client
              support</td>
                    <td align="center">built-in into all Mac OS versions</td>
                    <td align="center">built-in in all Mac OS versions except 10.0. Has to be
              activated explicitly in later Mac OS X versions</td>
                    <td align="center">built-in into almost all Mac OS versions</td>
                    <td align="center">built-in since AppleShare client 3.8.4, available as a
              plug-in for 3.8.3, integrated in macOS's AFP client</td>
                    <td align="center">built-in since Mac OS X 10.2</td>
                    <td align="center">built-in since Mac OS X 10.2</td>
                  </tr>
                  <tr>
                    <td align="center" valign="middle">Encryption</td>
                    <td align="center">Enables guest access without authentication between
              client and server.</td>
                    <td align="center">Password will be sent in cleartext over the wire. Just as
              bad as it sounds, therefore avoid at all if possible (note:
              providing NetBoot services requires the ClearTxt UAM)</td>
                    <td align="center">8-byte random numbers are sent over the wire, comparable
              with DES, 56 bits. Vulnerable to offline dictionary attack.
              Requires passwords in clear on the server.</td>
                    <td align="center">Password will be encrypted with 128 bit SSL, user will be
              authenticated against the server but not vice versa. Therefore
              weak against man-in-the-middle attacks.</td>
                    <td align="center">Password will be encrypted using libgcrypt with CAST 128
              in CBC mode. User will be authenticated against the server but
              not vice versa. Therefore weak against man-in-the-middle
              attacks.</td>
                    <td align="center">Password is not sent over the network. Due to the service
              principal detection method, this authentication method is
              vulnerable to man-in-the-middle attacks.</td>
                  </tr>
                  <tr>
                    <td align="center" valign="middle">Server
              support</td>
                    <td align="center" valign="middle">uams_guest.so</td>
                    <td align="center" valign="middle">uams_cleartxt.so</td>
                    <td align="center" valign="middle">uams_randnum.so</td>
                    <td align="center" valign="middle">uams_dhx.so</td>
                    <td align="center" valign="middle">uams_dhx2.so</td>
                    <td align="center" valign="middle">uams_gss.so</td>
                  </tr>
                  <tr>
                    <td align="center" valign="middle">Password
              storage method</td>
                    <td align="center" valign="middle">None</td>
                    <td align="center" valign="middle">Either /etc/passwd
              (/etc/shadow) or PAM</td>
                    <td align="center" valign="middle">Passwords stored in clear
              text in a separate text file</td>
                    <td align="center" valign="middle">Either /etc/passwd
              (/etc/shadow) or PAM</td>
                    <td align="center" valign="middle">Either /etc/passwd
              (/etc/shadow) or PAM</td>
                    <td align="center" valign="middle">At the Kerberos Key
              Distribution Center*</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <br class="table-break" />
          <p>* Have a look at this <a class="ulink" href="https://web.archive.org/web/20070705043002/http://cryptnet.net/fdp/admin/kerby-infra/en/kerby-infra.html" target="_top">Kerberos
      overview</a></p>
        </div>
        <div class="sect2">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="sshtunnel"></a>SSH tunneling</h3>
              </div>
            </div>
          </div>
          <p>Tunneling and VPNs usually have nothing to do with AFP
      authentication and UAMs. But since Apple introduced an option called
      "Allow Secure Connections Using SSH" and many people tend to confuse the
      two, we'll cover this here.</p>
          <div class="sect3">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="manualsshtunnel"></a>Manually tunneling an AFP session</h4>
                </div>
              </div>
            </div>
            <p>This works since the first AFP servers that spoke "AFP over TCP"
        appeared in networks. One simply tunnels the remote server's AFP port
        to a local port different than 548 and connects locally to this port
        afterwards. On macOS this can be done by</p>
            <pre class="programlisting">ssh -l $USER $SERVER -L 10548:127.0.0.1:548 sleep 3000</pre>
            <p>After establishing the tunnel one will use
        <code class="filename">"afp://127.0.0.1:10548"</code> in the "Connect to
        server" dialog. All AFP traffic including the initial connection
        attempts will be sent encrypted over the wire since the local AFP
        client will connect to the Mac's local port 10548 which will be
        forwarded to the remote server's AFP port (we used the default 548)
        over SSH.</p>
            <p>This sort of tunnel is an ideal solution if you must access an
        AFP server through the Internet without having the ability or desire
        to use a "real" VPN. Note that you can let <span class="command"><strong>ssh</strong></span>
        compress the data by using its "-C" switch and that the tunnel
        endpoints can be different from both AFP client and server (compare
        with the SSH documentation for details).</p>
          </div>
          <div class="sect3">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="autosshtunnel"></a>Automatically establishing a tunneled AFP connection</h4>
                </div>
              </div>
            </div>
            <p>From Mac OS X 10.2 to 10.4, Apple added an "Allow Secure
        Connections Using SSH" checkbox to the "Connect to Server" dialog. The
        idea behind this was: When the server signals that it can be contacted
        by SSH then macOS's AFP client tries to establish the tunnel and
        automagically send all AFP traffic through it.</p>
            <p>But it took until the release of Mac OS X 10.3 that this feature
        worked the first time... partly. In case, the SSH tunnel could not be
        established and the AFP client <span class="strong"><strong>silently</strong></span> fell back to an unencrypted AFP
        connection attempt.</p>
            <p>Netatalk's afpd will report that it is capable of handling SSH
        tunneled AFP requests, when both "<code class="option">advertise ssh</code>" and
        "<code class="option">fqdn</code>" options are set in the <code class="option">Global</code>
        section (double check with <span class="citerefentry"><span class="refentrytitle">asip-status</span>(1)</span> after you restarted afpd when you made changes to
        the settings). But there are a couple of reasons why you don't want to
        use this option at all:</p>
            <div class="itemizedlist">
              <ul class="itemizedlist" style="list-style-type: disc; ">
                <li class="listitem">
                  <p>Most users who need such a feature are probably already
            familiar with using a VPN; it might be easier for the user to
            employ the same VPN software in order to connect to the network on
            which the AFP server is running, and then to access the AFP server
            as normal.</p>
                  <p>That being said, for the simple case of connecting to one
            specific AFP server, a direct SSH connection is likely to perform
            better than a general-purpose VPN; contrary to popular belief,
            tunneling via SSH does <span class="strong"><strong>not</strong></span>
            result in what's called "TCP-over-TCP meltdown", because the AFP
            data that are being tunneled do not encapsulate TCP data.</p>
                </li>
                <li class="listitem">
                  <p>Since this SSH kludge isn't a normal UAM that integrates
            directly into the AFP authentication mechanisms but instead uses a
            single flag signalling clients whether they can <span class="strong"><strong>try</strong></span> to establish a tunnel or not, it
            makes life harder to see what's happening when things go
            wrong.</p>
                </li>
                <li class="listitem">
                  <p>You cannot control which machines are logged on by Netatalk
            tools like a <span class="command"><strong>macusers</strong></span> since all connection
            attempts seem to be made from localhost.</p>
                </li>
                <li class="listitem">
                  <p>Indeed, to ensure that all AFP sessions are encrypted via
            SSH, you need to limit afpd to connections that originate only
            from localhost (e.g., by using Wietse Venema's TCP Wrappers, or by
            using suitable firewall or packet-filtering facilities,
            etc.).</p>
                  <p>Otherwise, when you're using Mac OS X 10.2 through 10.3.3,
            you get the opposite of what you'd expect: potentially unencrypted
            AFP communications (including login credentials) being sent across
            the network without a single notification that establishing the
            tunnel failed. Apple fixed that with Mac OS X 10.3.4.</p>
                </li>
                <li class="listitem">
                  <p>Encrypting all AFP sessions via SSH can lead to a
            significantly higher load on the computer that is running the AFP
            server, because that computer must also handle encryption; if the
            user is connecting through a trusted network, then such encryption
            might be an unnecessary overhead.</p>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="sect1">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title" style="clear: both"><a id="acls"></a>ACL Support<a id="id-1.6.6.1.1" class="indexterm"></a></h2>
            </div>
          </div>
        </div>
        <p>ACL support for AFP is implemented for ZFS ACLs on Solaris and
    derived platforms and for POSIX 1e ACLs on Linux.</p>
        <div class="sect2">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="id-1.6.6.3"></a>Configuration</h3>
              </div>
            </div>
          </div>
          <p>For a basic mode of operation there's nothing to configure.
      Netatalk reads ACLs on the fly and calculates effective permissions
      which are then send to the AFP client via the so called
      UARights<a id="id-1.6.6.3.2.1" class="indexterm"></a> permission bits. On a Mac, the Finder uses these bits to
      adjust permission in Finder windows. Example: a folder whose UNIX mode
      is read-only and an ACL giving the user write access, will display the
      effective read-write permission. Without the permission mapping the
      Finder would display a read-only icon and the user wouldn't be able to
      write to the folder.</p>
          <p>By default, the effective permission of the authenticated user are
      only mapped to the mentioned UARights<a id="id-1.6.6.3.3.1" class="indexterm"></a>permission structure, not the UNIX mode. You can adjust
      this behaviour with the configuration option <a class="link" href="afp.conf.5.html#map_acls">map acls</a>.</p>
          <p>However, neither in Finder "Get Info" windows nor in the Terminal
      will you be able to see the ACLs, because of how ACLs in macOS are
      designed. If you want to be able to display ACLs on the client, things
      get more involved as you must then setup both client and server to be
      part on a authentication domain (directory service, e.g. LDAP,
      OpenDirectory). The reason is, that in macOS ACLs are bound to UUIDs,
      not just uid's or gid's. Therefore afpd must be able to map every
      filesystem uid and gid to a UUID so that it can return the server side
      ACLs which are bound to UNIX uid and gid mapped to macOS UUIDs.</p>
          <p>Netatalk can query a directory server using LDAP queries. Either
      the directory server already provides an UUID attribute for user and
      groups (Active Directory, Open Directory) or you reuse an unused
      attribute (or add a new one) to you directory server (eg
      OpenLDAP).</p>
          <p>In detail:</p>
          <div class="orderedlist">
            <ol class="orderedlist" type="1">
              <li class="listitem">
                <p>For Solaris/ZFS: ZFS Volumes</p>
                <p>You should configure a ZFS ACL know for any volume you want to
          use with Netatalk:</p>
                <pre class="screen">aclinherit = passthrough
aclmode = passthrough</pre>
                <p>For an explanation of what this knob does and how to apply it,
          check your hosts ZFS documentation (eg man zfs).</p>
              </li>
              <li class="listitem">
                <p>Authentication Domain</p>
                <p>Your server and the clients must be part of a security
          association where identity data is coming from a common source. ACLs
          in Darwin are based on UUIDs and so is the ACL specification in AFP
          3.2. Therefore your source of identity data has to provide an
          attribute for every user and group where a UUID is stored as a ASCII
          string. In other words:</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: disc; ">
                    <li class="listitem">
                      <p>you need an Open Directory Server or an LDAP server where
              you store UUIDs in some attribute</p>
                    </li>
                    <li class="listitem">
                      <p>your clients must be configured to use this server</p>
                    </li>
                    <li class="listitem">
                      <p>your server should be configured to use this server via
              nsswitch and PAM</p>
                    </li>
                    <li class="listitem">
                      <p>configure Netatalk via the special <a class="link" href="afp.conf.5.html#acl_options" title="Options for ACL handling">LDAP options for ACLs</a> in <a class="link" href="afp.conf.5.html" title="afp.conf">afp.conf</a> so that Netatalk is able to
              retrieve the UUID for users and groups via LDAP search
              queries</p>
                    </li>
                  </ul>
                </div>
              </li>
            </ol>
          </div>
        </div>
        <div class="sect2">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="id-1.6.6.4"></a>macOS ACLs</h3>
              </div>
            </div>
          </div>
          <p>With Access Control Lists (ACLs), macOS offers a powerful
      extension of the traditional UNIX permissions model. An ACL is an
      ordered list of Access Control Entries (ACEs) explicitly granting or
      denying a set of permissions to a given user or group.</p>
          <p>Unlike UNIX permissions, which are bound to user or group IDs,
      ACLs are tied to UUIDs. For this reason accessing an object's ACL
      requires server and client to use a common directory service which
      translates between UUIDs and user/group IDs.</p>
          <p>ACLs and UNIX permissions interact in a rather simple way. As ACLs
      are optional UNIX permissions act as a default mechanism for access
      control. Changing an objects's UNIX permissions will leave it's ACL
      intact and modifying an ACL will never change the object's UNIX
      permissions. While doing access checks, macOS first examines an object's
      ACL evaluating ACEs in order until all requested rights have been
      granted, a requested right has been explicitly denied by an ACE or the
      end of the list has been reached. In case there is no ACL or the
      permissions granted by the ACL are not sufficient to fulfill the
      request, macOS next evaluates the object's UNIX permissions. Therefore
      ACLs always have precedence over UNIX permissions.</p>
        </div>
        <div class="sect2">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="id-1.6.6.5"></a>ZFS ACLs</h3>
              </div>
            </div>
          </div>
          <p>ZFS ACLs closely match macOS ACLs. Both offer mostly identical
      fine grained permissions and inheritance settings.</p>
        </div>
        <div class="sect2">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="id-1.6.6.6"></a>POSIX ACLs</h3>
              </div>
            </div>
          </div>
          <div class="sect3">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="id-1.6.6.6.2"></a>Overview</h4>
                </div>
              </div>
            </div>
            <p>Compared to macOS or NFSv4 ACLs, POSIX ACLs represent a
        different, less versatile approach to overcome the limitations of the
        traditional UNIX permissions. Implementations are based on the
        withdrawn POSIX 1003.1e standard.</p>
            <p>The standard defines two types of ACLs. Files and directories
        can have access ACLs which are consulted for access checks.
        Directories can also have default ACLs irrelevant to access checks.
        When a new object is created inside a directory with a default ACL,
        the default ACL is applied to the new object as it's access ACL.
        Subdirectories inherit default ACLs from their parent. There are no
        further mechanisms of inheritance control.</p>
            <p>Architectural differences between POSIX ACLs and macOS ACLs
        especially involve:</p>
            <div class="itemizedlist">
              <ul class="itemizedlist" style="list-style-type: disc; ">
                <li class="listitem">
                  <p>No fine-granular permissions model. Like UNIX permissions
              POSIX ACLs only differentiate between read, write and execute
              permissions.</p>
                </li>
                <li class="listitem">
                  <p>Entries within an ACL are unordered.</p>
                </li>
                <li class="listitem">
                  <p>POSIX ACLs can only grant rights. There is no way to
              explicitly deny rights by an entry.</p>
                </li>
                <li class="listitem">
                  <p>UNIX permissions are integrated into an ACL as special
              entries.</p>
                </li>
              </ul>
            </div>
            <p>POSIX 1003.1e defines 6 different types of ACL entries. The
        first three types are used to integrate standard UNIX permissions.
        They form a minimal ACL, their presence is mandatory and only one
        entry of each type is allowed within an ACL.</p>
            <div class="itemizedlist">
              <ul class="itemizedlist" style="list-style-type: disc; ">
                <li class="listitem">
                  <p>ACL_USER_OBJ: the owner's access rights.</p>
                </li>
                <li class="listitem">
                  <p>ACL_GROUP_OBJ: the owning group's access rights.</p>
                </li>
                <li class="listitem">
                  <p>ACL_OTHER: everybody's access rights.</p>
                </li>
              </ul>
            </div>
            <p>The remaining entry types expand the traditional permissions
        model:</p>
            <div class="itemizedlist">
              <ul class="itemizedlist" style="list-style-type: disc; ">
                <li class="listitem">
                  <p>ACL_USER: grants access rights to a certain user.</p>
                </li>
                <li class="listitem">
                  <p>ACL_GROUP: grants access rights to a certain group.</p>
                </li>
                <li class="listitem">
                  <p>ACL_MASK: limits the maximum access rights which can be
              granted by entries of type ACL_GROUP_OBJ, ACL_USER and
              ACL_GROUP. As the name suggests, this entry acts as a mask. Only
              one ACL_MASK entry is allowed per ACL. If an ACL contains
              ACL_USER or ACL_GROUP entries, an ACL_MASK entry must be present
              too, otherwise it is optional.</p>
                </li>
              </ul>
            </div>
            <p>In order to maintain compatibility with applications not aware
        of ACLs, POSIX 1003.1e changes the semantics of system calls and
        utilities which retrieve or manipulate an object's UNIX permissions.
        In case an object only has a minimal ACL, the group permissions bits
        of the UNIX permissions correspond to the value of the ACL_GROUP_OBJ
        entry.</p>
            <p>However, if the ACL also contains an ACL_MASK entry, the
        behavior of those system calls and utilities is different. The group
        permissions bits of the UNIX permissions correspond to the value of
        the ACL_MASK entry, i. e. calling "chmod g-w" will not only revoke
        write access for the group, but for all entities which have been
        granted write access by ACL_USER or ACL_GROUP entries.</p>
          </div>
          <div class="sect3">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="id-1.6.6.6.3"></a>Mapping POSIX ACLs to macOS ACLs</h4>
                </div>
              </div>
            </div>
            <p>When a client wants to read an object's ACL, afpd maps it's
        POSIX ACL onto an equivalent macOS ACL. Writing an object's ACL
        requires afpd to map an macOS ACL onto a POSIX ACL. Due to
        architectural restrictions of POSIX ACLs, it is usually impossible to
        find an exact mapping so that the result of the mapping process will
        be an approximation of the original ACL's semantic.</p>
            <div class="itemizedlist">
              <ul class="itemizedlist" style="list-style-type: disc; ">
                <li class="listitem">
                  <p>afpd silently discard entries which deny a set of
              permissions because they they can't be represented within the
              POSIX architecture.</p>
                </li>
                <li class="listitem">
                  <p>As entries within POSIX ACLs are unordered, it is
              impossible to preserve order.</p>
                </li>
                <li class="listitem">
                  <p>Inheritance control is subject to severe limitations as
              well:</p>
                  <div class="itemizedlist">
                    <ul class="itemizedlist" style="list-style-type: circle; ">
                      <li class="listitem">
                        <p>Entries with the only_inherit flag set will only
                    become part of the directory's default ACL.</p>
                      </li>
                      <li class="listitem">
                        <p>Entries with at least one of the flags file_inherit,
                    directory_inherit or limit_inherit set, will become part
                    of the directory's access and default ACL, but the
                    restrictions they impose on inheritance will be
                    ignored.</p>
                      </li>
                    </ul>
                  </div>
                </li>
                <li class="listitem">
                  <p>The lack of a fine-granular permission model on the POSIX
              side will normally result in an increase of granted
              permissions.</p>
                </li>
              </ul>
            </div>
            <p>As macOS clients aren't aware of the POSIX 1003.1e specific
        relationship between UNIX permissions and ACL_MASK, afpd does not
        expose this feature to the client to avoid compatibility issues and
        handles *unix permissions and ACLs the same way as Apple's reference
        implementation of AFP does. When an object's UNIX permissions are
        requested, afpd calculates proper group rights and returns the result
        together with the owner's and everybody's access rights to the caller
        via "permissions" and "ua_permissions" members of the FPUnixPrivs
        structure (see Apple Filing Protocol Reference, page 181). Changing an
        object's permissions, afpd always updates ACL_USER_OBJ, ACL_GROUP_OBJ
        and ACL_OTHERS. If an ACL_MASK entry is present too, afpd recalculates
        it's value so that the new group rights become effective and existing
        entries of type ACL_USER or ACL_GROUP stay intact.</p>
          </div>
        </div>
      </div>
      <div class="sect1">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title" style="clear: both"><a id="fce"></a>Filesystem Change Events<a id="id-1.6.7.1.1" class="indexterm"></a></h2>
            </div>
          </div>
        </div>
        <p>Netatalk includes a nifty filesystem change event (FCE) mechanism
    where afpd processes notfiy interested listeners about certain filesystem
    event by UDP network datagrams.</p>
        <p>For the format of the UDP packets and for an example C application
    that demonstrates how to use these in a listener, take a look at the
    Netatalk source file <code class="filename">bin/misc/fce.c</code>.</p>
        <p>The currently supported FCE v1 events are:</p>
        <div class="itemizedlist">
          <ul class="itemizedlist" style="list-style-type: disc; ">
            <li class="listitem">
              <p>file modification (fmod)</p>
            </li>
            <li class="listitem">
              <p>file deletion (fdel)</p>
            </li>
            <li class="listitem">
              <p>directory deletion (ddel)</p>
            </li>
            <li class="listitem">
              <p>file creation (fcre)</p>
            </li>
            <li class="listitem">
              <p>directory creation (dcre)</p>
            </li>
          </ul>
        </div>
        <p>When using FCE v2 you also get:</p>
        <div class="itemizedlist">
          <ul class="itemizedlist" style="list-style-type: disc; ">
            <li class="listitem">
              <p>file moving (fmov)</p>
            </li>
            <li class="listitem">
              <p>directory moving (dmov)</p>
            </li>
            <li class="listitem">
              <p>user login (login)</p>
            </li>
            <li class="listitem">
              <p>user logout (logout)</p>
            </li>
          </ul>
        </div>
        <p>For details on the available simple configuration options, take a
    look at <code class="filename"><a class="link" href="afp.conf.5.html#fceconf" title="Filesystem Change Events (FCE)">afp.conf</a></code>.</p>
      </div>
      <div class="sect1">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title" style="clear: both"><a id="id-1.6.8"></a>Spotlight<a id="id-1.6.8.1.1" class="indexterm"></a></h2>
            </div>
          </div>
        </div>
        <p>Starting with version 3.1 Netatalk supports Spotlight searching.
    Netatalk uses GNOME <a class="ulink" href="https://projects.gnome.org/tracker/" target="_top">Tracker</a> as metadata
    store, indexer and search engine.</p>
        <div class="sect2">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="id-1.6.8.3"></a>Configuration</h3>
              </div>
            </div>
          </div>
          <p>You can enable Spotlight and indexing either globally or on a per
      volume basis with the <code class="option">spotlight</code> option.</p>
          <div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;">
            <h3 class="title">Warning</h3>
            <p>Once Spotlight is enabled for a single volume, all other volumes
        for which spotlight is disabled won't be searchable at all.</p>
          </div>
          <p>The <span class="command"><strong>dbus-daemon</strong></span> binary has to be installed for
      Spotlight feature. The path to dbus-daemon is determined at compile time
      the dbus-daemon build system option.</p>
          <p>In case the <span class="command"><strong>dbus-daemon</strong></span> binary is installed at
      the other path, you must use the global option <code class="option">dbus
      daemon</code> to point to the path, e.g. for Solaris with Tracker from
      OpenCSW:</p>
          <pre class="screen">dbus daemon = /opt/csw/bin/dbus-daemon</pre>
          <div class="sect3">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="id-1.6.8.3.6"></a>Limitations and notes</h4>
                </div>
              </div>
            </div>
            <div class="itemizedlist">
              <ul class="itemizedlist" style="list-style-type: disc; ">
                <li class="listitem">
                  <p>Large filesystems</p>
                  <p>Tracker on Linux uses the inotify Kernel filesystem change
            event API for tracking filesystem changes. On large filesystems
            this may be problematic since the inotify API doesn't offer
            recursive directory watches but instead requires that for every
            subdirectoy watches must be added individually.</p>
                  <p>On Solaris the FEN file event notification system is used.
            It is unknown which limitations and resource consumption this
            Solaris subsystem may have.</p>
                  <p>We therefore recommend to disable live filesystem monitoring
            and let Tracker periodically scan filesystems for changes instead,
            see the Tracker configuration options <a class="link" href="configuration.html#enable-monitors">enable-monitors</a> and <a class="link" href="configuration.html#crawling-interval">crawling-interval</a> below.</p>
                </li>
                <li class="listitem">
                  <p>Indexing home directories</p>
                  <p>A known limitation with the current implementation means
            that shared volumes in a user's home directory does not get
            indexed by Spotlight.</p>
                  <p>As a workaround, keep the shared volumes you want to have
            indexed elsewhere on the host filesystem.</p>
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="sect2">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="id-1.6.8.4"></a>Using Tracker commandline tools on the server</h3>
              </div>
            </div>
          </div>
          <p>Netatalk must be running, commands must be executed as root and
      some environment variables must be set up.</p>
          <p>If the .tracker_profile file does not exist, create it first. If
      you need to make the environment variables persistent, source
      .tracker_profile from /root/.profile. If needed, adjust PREFIX to point
      to the base directory Netatalk is installed to, and replace "/var" with
      the localstate directory configured at compile time. </p>
          <pre class="screen">$ su
      # cat .tracker_profile
      PREFIX="/usr/local"
      export XDG_DATA_HOME="$PREFIX/var/netatalk/"
      export XDG_CACHE_HOME="$PREFIX/var/netatalk/"
      export DBUS_SESSION_BUS_ADDRESS="unix:path=$PREFIX/var/netatalk/spotlight.ipc"
      # . .tracker_profile
      #
      </pre>
          <p>When using Tracker from OpenCSW you must also update your
      PATH:</p>
          <pre class="screen"># export PATH=/opt/csw/bin:$PATH</pre>
          <div class="sect3">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="id-1.6.8.4.5"></a>Common Tracker commands</h4>
                </div>
              </div>
            </div>
            <div class="variablelist">
              <dl class="variablelist">
                <dt>
                  <span class="term">Querying Tracker status:</span>
                </dt>
                <dd>
                  <pre class="screen"># tracker daemon</pre>
                </dd>
                <dt>
                  <span class="term">Stop Tracker:</span>
                </dt>
                <dd>
                  <pre class="screen"># tracker daemon -t</pre>
                </dd>
                <dt>
                  <span class="term">Start Tracker:</span>
                </dt>
                <dd>
                  <pre class="screen"># tracker daemon -s</pre>
                </dd>
                <dt>
                  <span class="term">Reindex directory:</span>
                </dt>
                <dd>
                  <pre class="screen"># tracker index -f PATH</pre>
                </dd>
                <dt>
                  <span class="term">Query Tracker for information about a file or
            directory:</span>
                </dt>
                <dd>
                  <pre class="screen"># tracker info PATH</pre>
                </dd>
                <dt>
                  <span class="term">Search Tracker:</span>
                </dt>
                <dd>
                  <pre class="screen"># tracker search QUERY</pre>
                </dd>
              </dl>
            </div>
          </div>
          <div class="sect3">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="id-1.6.8.4.6"></a>Advanced Tracker command line configuration</h4>
                </div>
              </div>
            </div>
            <p>Tracker stores its configuration via Gnome dconf backend which
        can be modified with the command <span class="command"><strong>gsettings</strong></span>.</p>
            <p>Gnome dconf settings are per-user settings, so, as Netatalk runs
        the Tracker processes as root, the settings are stored in the root
        user context and reading or changing these settings must be performed
        as root and Netatalk must be running (and again the environment must
        be set up as shown above).</p>
            <pre class="screen"># gsettings list-recursively | grep Tracker
org.freedesktop.Tracker.Writeback verbosity 'debug'
...</pre>
            <p>The following list describes some important Tracker options and
        their default settings.</p>
            <div class="variablelist">
              <dl class="variablelist">
                <dt>
                  <span class="term">org.freedesktop.Tracker.Miner.Files
            index-recursive-directories</span>
                </dt>
                <dd>
                  <p>This option controls which directories Tracker will index.
              Don't change this option manually as it is automatically set by
              Netatalk reflecting the setting of the
              <code class="option">Spotlight</code> option of Netatalk volumes.</p>
                </dd>
                <dt>
                  <span class="term"><a id="enable-monitors"></a>org.freedesktop.Tracker.Miner.Files
            enable-monitors <em class="parameter"><code> true</code></em></span>
                </dt>
                <dd>
                  <p>The value controls whether Tracker watches all configured
              paths for modification. Depending on the filesystem modification
              backend (FAM on Linux, FEN on Solaris), this feature may not
              work as reliable as one might wish, so it may be safer to
              disable it and instead rely on periodic crawling of Tracker
              itself. See aslo the option <code class="option">crawling-interval
              </code>.</p>
                </dd>
                <dt>
                  <span class="term"><a id="crawling-interval"></a>org.freedesktop.Tracker.Miner.Files
            crawling-interval <em class="parameter"><code>-1</code></em></span>
                </dt>
                <dd>
                  <p>Interval in days to check the filesystem is up to date in
              the database, maximum is 365, default is -1. -2 = crawling is
              disabled entirely, -1 = crawling *may* occur on startup (if not
              cleanly shutdown), 0 = crawling is forced</p>
                </dd>
              </dl>
            </div>
          </div>
        </div>
        <div class="sect2">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="id-1.6.8.5"></a>Supported metadata attributes</h3>
              </div>
            </div>
          </div>
          <p>The following table lists the supported Spotlight metadata
      attributes</p>
          <div class="table">
            <a id="id-1.6.8.5.3"></a>
            <p class="title">
              <strong>Table 3.2. Supported Spotlight metadata attributes</strong>
            </p>
            <div class="table-contents">
              <table class="table" summary="Supported Spotlight metadata attributes" border="1">
                <colgroup>
                  <col />
                  <col />
                </colgroup>
                <thead>
                  <tr>
                    <th align="center">Description</th>
                    <th align="center">Spotlight Key</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Name</td>
                    <td>kMDItemDisplayName, kMDItemFSName</td>
                  </tr>
                  <tr>
                    <td>Document content (full text search)</td>
                    <td>kMDItemTextContent</td>
                  </tr>
                  <tr>
                    <td>File type</td>
                    <td>_kMDItemGroupId, kMDItemContentTypeTree</td>
                  </tr>
                  <tr>
                    <td>File modification date</td>
                    <td>kMDItemFSContentChangeDate,
              kMDItemContentModificationDate,
              kMDItemAttributeChangeDate</td>
                  </tr>
                  <tr>
                    <td>Content Creation date</td>
                    <td>kMDItemContentCreationDate</td>
                  </tr>
                  <tr>
                    <td>The author, or authors, of the contents of the
              file</td>
                    <td>kMDItemAuthors, kMDItemCreator</td>
                  </tr>
                  <tr>
                    <td>The name of the country where the item was
              created</td>
                    <td>kMDItemCountry</td>
                  </tr>
                  <tr>
                    <td>Duration</td>
                    <td>kMDItemDurationSeconds</td>
                  </tr>
                  <tr>
                    <td>Number of pages</td>
                    <td>kMDItemNumberOfPages</td>
                  </tr>
                  <tr>
                    <td>Document title</td>
                    <td>kMDItemTitle</td>
                  </tr>
                  <tr>
                    <td>The width, in pixels, of the contents. For example, the
              image width or the video frame width</td>
                    <td>kMDItemPixelWidth</td>
                  </tr>
                  <tr>
                    <td>The height, in pixels, of the contents. For example, the
              image height or the video frame height</td>
                    <td>kMDItemPixelHeight</td>
                  </tr>
                  <tr>
                    <td>The color space model used by the document
              contents</td>
                    <td>kMDItemColorSpace</td>
                  </tr>
                  <tr>
                    <td>The number of bits per sample</td>
                    <td>kMDItemBitsPerSample</td>
                  </tr>
                  <tr>
                    <td>Focal length of the lens, in millimeters</td>
                    <td>kMDItemFocalLength</td>
                  </tr>
                  <tr>
                    <td>ISO speed</td>
                    <td>kMDItemISOSpeed</td>
                  </tr>
                  <tr>
                    <td>Orientation of the document. Possible values are 0
              (landscape) and 1 (portrait)</td>
                    <td>kMDItemOrientation</td>
                  </tr>
                  <tr>
                    <td>Resolution width, in DPI</td>
                    <td>kMDItemResolutionWidthDPI</td>
                  </tr>
                  <tr>
                    <td>Resolution height, in DPI</td>
                    <td>kMDItemResolutionHeightDPI</td>
                  </tr>
                  <tr>
                    <td>Exposure time, in seconds</td>
                    <td>kMDItemExposureTimeSeconds</td>
                  </tr>
                  <tr>
                    <td>The composer of the music contained in the audio
              file</td>
                    <td>kMDItemComposer</td>
                  </tr>
                  <tr>
                    <td>The musical genre of the song or composition</td>
                    <td>kMDItemMusicalGenre</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <br class="table-break" />
          <div class="sect3">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="id-1.6.8.5.4"></a>References</h4>
                </div>
              </div>
            </div>
            <div class="orderedlist">
              <ol class="orderedlist" type="1">
                <li class="listitem">
                  <p>
                    <a class="ulink" href="https://developer.apple.com/documentation/coreservices/mditemref/" target="_top">MDItem</a>
                  </p>
                </li>
                <li class="listitem">
                  <p>
                    <a class="ulink" href="https://gnome.pages.gitlab.gnome.org/tracker/docs/developer/" target="_top">Tracker</a>
                  </p>
                </li>
              </ol>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="navfooter">
      <hr />
      <table width="100%" summary="Navigation footer">
        <tr>
          <td width="40%" align="left"><a accesskey="p" href="installation.html">Prev</a> </td>
          <td width="20%" align="center"> </td>
          <td width="40%" align="right"> <a accesskey="n" href="appletalk.html">Next</a></td>
        </tr>
        <tr>
          <td width="40%" align="left" valign="top">Chapter 2. Installation </td>
          <td width="20%" align="center">
            <a accesskey="h" href="index.html">Home</a>
          </td>
          <td width="40%" align="right" valign="top"> Chapter 4. AppleTalk</td>
        </tr>
      </table>
    </div>
  </body>
</html>
